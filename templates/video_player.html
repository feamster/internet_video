{% extends 'base.html' %}

{% block page_content %}
<title>Video Player</title>
<script src="http://vjs.zencdn.net/5-unsafe/video.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-resolution-switcher/0.4.2/videojs-resolution-switcher.js"></script>

<main role="main" class="flex-shrink-0">
  <div class="container">
	<div class="video-js-box">
    <br/><br/>
    <br/><br/>
    <video id="video_player" class="video-js" width="1280" height="720" controls="controls" autoplay data-setup='{}' preload="auto">
    	{{videosource | safe}}
      <script>
        videojs('video_player').videoJsResolutionSwitcher()
      </script>

     <style>
      #downloadButton {
          width: 25px;
          height: 25px;
          margin-top: 5px;
      }
    </style>

      <script>
        videojs('video_player').ready(function() {
          var myPlayer = this,
            controlBar,
            newElement = document.createElement('div'),
            newLink = document.createElement('button'),
            newImage = document.createElement('img');
          newElement.id = 'downloadButton';
          newElement.className = 'downloadStyle vjs-control';
          newImage.setAttribute('src','{{ url_for('static', filename='p1.png')}}');
          newLink.setAttribute('onclick', 'facepost(1)');
          newLink.appendChild(newImage);
          newElement.appendChild(newLink);
          controlBar = document.getElementsByClassName('vjs-control-bar')[0];
          insertBeforeNode = document.getElementsByClassName('vjs-volume-menu-button')[0];
          controlBar.insertBefore(newElement,insertBeforeNode);
        });
      </script>

      <script>
        videojs('video_player').ready(function() {
          var myPlayer = this,
            controlBar,
            newElement = document.createElement('div'),
            newLink = document.createElement('button'),
            newImage = document.createElement('img');
          newElement.id = 'downloadButton';
          newElement.className = 'downloadStyle vjs-control';
          newImage.setAttribute('src','{{ url_for('static', filename='p2.png')}}');
          newLink.setAttribute('onclick', 'facepost(2)');
          newLink.appendChild(newImage);
          newElement.appendChild(newLink);
          controlBar = document.getElementsByClassName('vjs-control-bar')[0];
          insertBeforeNode = document.getElementsByClassName('vjs-volume-menu-button')[0];
          controlBar.insertBefore(newElement,insertBeforeNode);
        });
      </script>

      <script>
        videojs('video_player').ready(function() {
          var myPlayer = this,
            controlBar,
            newElement = document.createElement('div'),
            newLink = document.createElement('button'),
            newImage = document.createElement('img');
          newElement.id = 'downloadButton';
          newElement.className = 'downloadStyle vjs-control';
          newImage.setAttribute('src','{{ url_for('static', filename='p3.png')}}');
          newLink.setAttribute('onclick', 'facepost(3)');
          newLink.appendChild(newImage);
          newElement.appendChild(newLink);
          controlBar = document.getElementsByClassName('vjs-control-bar')[0];
          insertBeforeNode = document.getElementsByClassName('vjs-volume-menu-button')[0];
          controlBar.insertBefore(newElement,insertBeforeNode);
        });
      </script>

      <script>
        videojs('video_player').ready(function() {
          var myPlayer = this,
            controlBar,
            newElement = document.createElement('div'),
            newLink = document.createElement('button'),
            newImage = document.createElement('img');
          newElement.id = 'downloadButton';
          newElement.className = 'downloadStyle vjs-control';
          newImage.setAttribute('src','{{ url_for('static', filename='p4.png')}}');
          newLink.appendChild(newImage);
          newLink.setAttribute('onclick', 'facepost(4)');
          newElement.appendChild(newLink);
          controlBar = document.getElementsByClassName('vjs-control-bar')[0];
          insertBeforeNode = document.getElementsByClassName('vjs-volume-menu-button')[0];
          controlBar.insertBefore(newElement,insertBeforeNode);
        });
      </script>

      <script>
        videojs('video_player').ready(function() {
          var myPlayer = this,
            controlBar,
            newElement = document.createElement('div'),
            newLink = document.createElement('button'),
            newImage = document.createElement('img');
          newElement.id = 'downloadButton';
          newElement.className = 'downloadStyle vjs-control';
          newImage.setAttribute('src','{{ url_for('static', filename='p5.png')}}');
          newLink.appendChild(newImage);
          newLink.setAttribute('onclick', 'facepost(5)');
          newElement.appendChild(newLink);
          controlBar = document.getElementsByClassName('vjs-control-bar')[0];
          insertBeforeNode = document.getElementsByClassName('vjs-volume-menu-button')[0];
          controlBar.insertBefore(newElement,insertBeforeNode);
        });
      </script>

      <script>
        function facepost(a){
          var timestamp = new Date().getTime();
          console.log("Current Time: " + timestamp + " User choose fase #: " + a);

          var httpRequest = new XMLHttpRequest();
          var report = "";
          var url = '/post/'

          var webpage_url = document.location.toString();
          report = "posttype=2&" + "site=" + webpage_url + "&";
          
          httpRequest.open('POST', url, true);
          httpRequest.setRequestHeader("Content-type","application/x-www-form-urlencoded");
          report = report + "time=" + timestamp + '&' + "slider=-" + a;
          httpRequest.send(report);
          
          httpRequest.onreadystatechange = function () {
             var json = httpRequest.responseText;
          };

        }
      </script>
    </video>

   <p class="lead" align="justify"> {{userinfo | safe}} </p> 

   <script>
    const $ = document.querySelector.bind(document)
    const vid = videojs('video_player')
    const aud = $('#audio')
    vid.on('play', aud.play.bind(aud))
    vid.on('pause', aud.pause.bind(aud))
    let last = vid.currentTime()
    vid.on('timeupdate', e => {
      let cur = vid.currentTime()
      if (Math.abs(cur - last) > 0.5) {
        aud.currentTime = cur
        last = cur
      }
    })
    vid.on('volumechange', e => {
      aud.volume = vid.volume()
    })
  </script>

  <script type="text/javascript">
    var player = videojs('video_player');
    player.on('resolutionchange', function(){
      console.info('Source changed to %s', player.src())
    })
  </script>

  <script>
    var player = videojs('video_player');
    var eventPoller = setInterval(function() {
      var buffered = player.buffered();
      var curTime = player.currentTime();
      var timestamp = new Date().getTime();
      var currentResolution = player.currentResolution(null).label;

      var httpRequest = new XMLHttpRequest();
      var report = "";
      var url = '/post/'

      httpRequest.open('POST', url, true);
      httpRequest.setRequestHeader("Content-type","application/x-www-form-urlencoded");

      var webpage_url = document.location.toString();
      report = "posttype=1&" + "site=" + webpage_url + "&";

      for(i=0;i<buffered.length;i++)
      {
        if (buffered.start(i) <= curTime && curTime <= buffered.end(i))
        {
          console.log("Timestamp: " + timestamp + ", " + "Player Time: " + curTime + ", " + "Current Buffer: " + (buffered.end(i) - curTime) + ", Current Resolution: " + currentResolution);
          report = report + "time=" + timestamp + "&" + "player=" + curTime + "&" + "buffer=" + (buffered.end(i) - curTime) + "&" + "res=" + currentResolution;
//           report = "Timestamp: " + timestamp + ", "+ "Player Time: " + curTime + ", " + "Current Buffer: " + (buffered.end(i) - curTime) + ", " + "Current Resolution: " + currentResolution;
        }
      }
      httpRequest.send(report);
      httpRequest.onreadystatechange = function () {
        var json = httpRequest.responseText;
      };
    }, 1000)
  </script>
  </div>

  <br/><br/>
  <h4 class="mb-3">Video Quality Survey</h4>

  <h6>How do you satisfy with the video quality you are watching? (Very Bad: 0, Excellent: 100) </h6>
  <input id="videoscore" type="text" class="form-control" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="50"/>
  <span id="videoscoreCurrentSliderValLabel"> Video Score: <span id="VideoScoreSliderVal">50</span></span>
  <script type="text/javascript">
    var slider = new Slider("#videoscore");
    slider.on("slide", function(sliderValue) {
          document.getElementById("VideoScoreSliderVal").textContent = sliderValue;
    });

    slider.on("slideStop", function(sliderValue) {
          var timestamp = new Date().getTime();
          console.log("Current Time: " + timestamp + " User Change Video Score to: " + sliderValue);

          var httpRequest = new XMLHttpRequest();
          var report = "";
          var url = '/post/'

          var webpage_url = document.location.toString();
          report = "posttype=2&" + "site=" + webpage_url + "&";
          
          httpRequest.open('POST', url, true);
          httpRequest.setRequestHeader("Content-type","application/x-www-form-urlencoded");
          report = report + "time=" + timestamp + '&' + "slider=" + sliderValue;
//          report = "Current Time: " + timestamp + " User Change Video Score to: " + sliderValue;
          httpRequest.send(report);
          
      httpRequest.onreadystatechange = function () {
         var json = httpRequest.responseText;
      };
    });

  </script>
    
  </div>

</main>
{% endblock %}
